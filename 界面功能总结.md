# MusicZone 应用界面功能与实现总结

## 一、SQLite数据库设计

### 数据库结构
数据库名称：`music_app.db`，版本：4

### 数据表设计

#### 1. **songs表** - 音乐信息表
- `_id`: 主键，自增ID
- `title`: 歌曲标题
- `artist`: 艺术家
- `album`: 专辑名
- `duration`: 时长（毫秒）
- `file_path`: 文件路径（唯一）
- `file_size`: 文件大小
- `date_added`: 添加时间
- `album_art_path`: 专辑封面路径

#### 2. **users表** - 用户表
- `_id`: 主键，用户ID
- `username`: 用户名（唯一）
- `password`: 密码
- `email`: 邮箱
- `created_at`: 创建时间

#### 3. **favorites表** - 收藏表
- `user_id`: 用户ID（外键）
- `song_id`: 歌曲ID（外键）
- `date_added`: 添加时间
- 复合主键：`(user_id, song_id)`

#### 4. **feedback表** - 反馈表
- `_id`: 主键
- `content`: 反馈内容
- `date_added`: 添加时间

### 数据库操作类：MusicDBHelper
- 继承自`SQLiteOpenHelper`
- 负责数据库创建、升级和数据操作
- 使用SharedPreferences存储当前登录用户ID

---

## 二、登录注册界面 (LoginActivity)

### 功能概述
实现用户登录、注册和密码找回功能（密码找回未实现）

### 主要功能

#### 1. **用户登录**
- **输入验证**：检查用户名和密码是否为空
- **数据库查询**：调用`dbHelper.loginUser(username, password)`
  - 查询users表验证用户名和密码
  - 登录成功后保存用户ID到SharedPreferences
- **跳转**：登录成功后跳转到`ChooseStyleActivity`

#### 2. **用户注册**
- **注册对话框**：使用AlertDialog显示注册表单
- **输入验证**：
  - 用户名不能为空
  - 密码不能为空
  - 密码确认必须匹配
  - 密码长度至少3位
  - 检查用户名是否已存在（`dbHelper.checkUsernameExists()`）
- **数据库操作**：调用`dbHelper.registerUser(username, password)`
  - 插入新用户到users表
  - 用户名唯一性约束

#### 3. **密码找回**
- 当前仅显示提示信息，功能未实现

### 实现技术
- **UI组件**：EditText（用户名、密码）、Button（登录）、TextView（注册、忘记密码）
- **数据库操作**：通过MusicDBHelper进行用户验证和注册
- **数据持久化**：使用SharedPreferences存储当前用户ID

---

## 三、音乐播放界面 (MusicPlayerActivity)

### 功能概述
扫描设备音乐文件、显示播放列表、播放控制、收藏管理

### 主要功能

#### 1. **音乐扫描与加载**
- **权限管理**：
  - Android 13+：请求`READ_MEDIA_AUDIO`权限
  - Android 13以下：请求`READ_EXTERNAL_STORAGE`权限
- **扫描流程**：
  - 使用`MusicScanner`扫描设备音乐文件
  - 将扫描结果保存到数据库（`dbHelper.insertSong()`）
  - 自动去重（`dbHelper.removeDuplicateSongs()`）
  - 从数据库读取歌曲列表（`dbHelper.getAllSongs()`）
- **缓存机制**：如果数据库已有数据，直接读取，避免重复扫描

#### 2. **播放列表显示**
- **RecyclerView**：使用`PlaylistAdapter`显示歌曲列表
- **列表项功能**：
  - 点击播放
  - 收藏/取消收藏
  - 更多选项（菜单）

#### 3. **播放控制**
- **MediaPlayer**：使用Android MediaPlayer播放音频
- **播放功能**：
  - 播放/暂停切换
  - 上一首/下一首（循环播放）
  - 进度条拖拽跳转
  - 自动播放下一首（播放完成监听）
- **进度更新**：Handler每100ms更新一次播放进度
- **时间显示**：当前时间、总时长、剩余时间

#### 4. **收藏功能**
- **添加收藏**：`dbHelper.addToFavorite(songId)`
- **移除收藏**：`dbHelper.removeFromFavorite(songId)`
- **收藏状态**：实时查询`dbHelper.isFavorite(songId)`

#### 5. **其他功能**
- **刷新按钮**：强制重新扫描音乐
- **定位按钮**：滚动到当前播放歌曲位置
- **菜单功能**：重复播放、随机播放、添加到播放列表、分享、设置、退出

### 实现技术
- **异步处理**：使用Kotlin Coroutines（IO线程扫描，Main线程更新UI）
- **媒体播放**：Android MediaPlayer API
- **数据库操作**：通过MusicDBHelper进行歌曲和收藏管理
- **UI更新**：Handler + Runnable实现进度更新

---

## 四、音乐推荐界面 (MusicRecommendationActivity)

### 功能概述
显示用户收藏的歌曲列表，支持播放控制

### 主要功能

#### 1. **收藏列表加载**
- **数据来源**：从数据库读取用户收藏的歌曲
- **数据库查询**：`dbHelper.getAllFavorites()`
  - 使用JOIN查询关联songs表和favorites表
  - 按添加时间倒序排列
  - 只显示当前登录用户的收藏

#### 2. **播放功能**
- **播放控制**：与MusicPlayerActivity相同的播放功能
  - 播放/暂停
  - 上一首/下一首
  - 进度条控制
  - 时间显示
- **MediaPlayer**：独立的MediaPlayer实例

#### 3. **收藏管理**
- **移除收藏**：点击收藏按钮可取消收藏
- **实时更新**：移除后自动刷新列表

#### 4. **空状态处理**
- 当没有收藏歌曲时，显示提示信息

### 实现技术
- **数据库查询**：JOIN查询获取收藏歌曲
- **播放功能**：复用MusicPlayerActivity的播放逻辑
- **UI适配器**：使用PlaylistAdapter显示收藏列表

---

## 五、音乐搜索界面 (SearchActivity)

### 功能概述
提供多维度搜索功能，支持歌曲、艺术家、专辑、播放列表搜索

### 主要功能

#### 1. **搜索输入**
- **实时搜索**：使用TextWatcher监听输入变化
- **防抖处理**：300ms延迟，避免频繁查询
- **搜索触发**：
  - 输入框内容变化（延迟300ms）
  - 点击搜索按钮（立即搜索）
  - 按Enter键（立即搜索）

#### 2. **分类筛选**
- **筛选类型**：
  - ALL：显示所有内容（歌曲、艺术家、专辑）
  - SONGS：仅显示歌曲
  - ARTISTS：仅显示艺术家
  - ALBUMS：仅显示专辑
  - PLAYLISTS：仅显示播放列表（未实现）

#### 3. **搜索功能**

##### 3.1 歌曲搜索
- **数据库查询**：`dbHelper.searchSongs(keyword)`
  - 搜索歌曲标题、艺术家、专辑名
  - 使用LIKE查询，支持模糊匹配
  - 不区分大小写

##### 3.2 艺术家搜索
- **数据库查询**：`dbHelper.getAllArtists(keyword)`
  - 从songs表中提取唯一艺术家
  - 支持关键词过滤

##### 3.3 专辑搜索
- **数据库查询**：`dbHelper.getAllAlbums(keyword)`
  - 从songs表中提取唯一专辑（包含艺术家信息）
  - 支持关键词过滤

#### 4. **结果显示**
- **ALL模式**：
  - 无关键词：显示"TRENDING"部分（最近5首歌曲）
  - 有关键词：按类别分组显示（SONGS、ARTISTS、ALBUMS）
- **分类模式**：显示对应类型的搜索结果
- **空状态**：无结果时显示占位符

#### 5. **交互功能**
- **点击歌曲**：跳转到MusicPlayerActivity播放
- **点击艺术家**：自动切换到SONGS筛选，搜索该艺术家的歌曲
- **点击专辑**：自动切换到SONGS筛选，搜索该专辑的歌曲
- **收藏功能**：支持在搜索结果中收藏/取消收藏

### 实现技术
- **异步搜索**：使用Kotlin Coroutines在IO线程执行搜索
- **防抖机制**：Handler + Runnable实现输入防抖
- **多RecyclerView**：不同筛选类型使用不同的RecyclerView
- **数据库查询**：使用SQL LIKE进行模糊搜索

---

## 六、意见反馈界面 (FeedbackActivity)

### 功能概述
允许用户提交反馈意见，保存到数据库

### 主要功能

#### 1. **反馈输入**
- **输入框**：EditText用于输入反馈内容
- **输入验证**：检查反馈内容是否为空

#### 2. **提交反馈**
- **数据库操作**：`dbHelper.insertFeedback(content)`
  - 插入反馈内容到feedback表
  - 自动记录提交时间
- **提交成功**：清空输入框，关闭界面
- **提交失败**：显示错误提示

#### 3. **UI设计**
- **背景动画**：使用Glide加载GIF背景图
- **返回按钮**：关闭当前界面

### 实现技术
- **数据库操作**：通过MusicDBHelper插入反馈数据
- **UI库**：使用Glide加载GIF图片
- **数据验证**：简单的空值检查

---

## 七、数据库操作总结

### 核心操作类：MusicDBHelper

#### 1. **歌曲管理**
- `insertSong()`: 插入歌曲（使用CONFLICT_IGNORE避免重复）
- `getAllSongs()`: 获取所有歌曲（按标题排序）
- `clearAllSongs()`: 清空所有歌曲
- `removeDuplicateSongs()`: 去除重复歌曲（基于标题+艺术家）

#### 2. **搜索功能**
- `searchSongs(keyword)`: 搜索歌曲（标题、艺术家、专辑）
- `getAllArtists(keyword)`: 获取艺术家列表（支持搜索）
- `getAllAlbums(keyword)`: 获取专辑列表（支持搜索）

#### 3. **收藏管理**
- `addToFavorite(songId)`: 添加收藏（需要登录用户）
- `removeFromFavorite(songId)`: 移除收藏
- `isFavorite(songId)`: 检查是否收藏
- `getAllFavorites()`: 获取所有收藏（JOIN查询）

#### 4. **用户管理**
- `registerUser(username, password)`: 注册用户
- `loginUser(username, password)`: 用户登录
- `checkUsernameExists(username)`: 检查用户名是否存在
- `getCurrentUserId()`: 获取当前登录用户ID（从SharedPreferences）
- `logout()`: 登出

#### 5. **反馈管理**
- `insertFeedback(content)`: 插入反馈

### 数据库版本升级
- **版本1→2**：添加favorites表
- **版本2→3**：添加users表，修改favorites表（添加user_id外键）
- **版本3→4**：添加feedback表

---

## 八、技术架构总结

### 1. **数据层**
- SQLite数据库：本地数据存储
- SharedPreferences：用户状态存储
- MusicDBHelper：数据库操作封装

### 2. **业务层**
- MusicScanner：音乐文件扫描
- 各Activity：业务逻辑处理

### 3. **表现层**
- RecyclerView：列表显示
- MediaPlayer：音频播放
- 各种UI组件：用户交互

### 4. **异步处理**
- Kotlin Coroutines：后台任务处理
- Handler：UI更新和定时任务

### 5. **权限管理**
- 运行时权限请求（存储权限）

---

## 九、关键实现细节

### 1. **数据库设计特点**
- 使用外键关联用户和收藏
- 支持数据库版本升级
- 使用CONFLICT_IGNORE避免重复数据

### 2. **播放功能特点**
- 异步准备MediaPlayer（prepareAsync）
- 播放完成自动下一首
- 进度更新使用Handler机制

### 3. **搜索功能特点**
- 防抖处理避免频繁查询
- 多线程处理（IO线程查询，Main线程更新UI）
- 支持模糊搜索和分类筛选

### 4. **用户体验优化**
- 音乐扫描缓存机制
- 实时搜索反馈
- 空状态提示
- 错误处理和提示

---

## 十、总结

本应用是一个功能完整的本地音乐播放器，主要特点：

1. **完整的用户系统**：登录、注册、用户状态管理
2. **音乐管理**：扫描、存储、去重、播放
3. **收藏功能**：基于用户的个性化收藏
4. **搜索功能**：多维度搜索，支持实时搜索
5. **反馈系统**：用户意见收集

所有数据都存储在本地SQLite数据库中，实现了数据的持久化存储和高效查询。

